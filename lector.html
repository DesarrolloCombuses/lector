<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>LECTOR QR - Aeropuerto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: #1a1a1a;
            border-radius: 20px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .camera-container {
            background: #000;
            position: relative;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #camera {
            width: 100%;
            height: auto;
            min-height: 400px;
            object-fit: cover;
        }

        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .scan-frame {
            width: 250px;
            height: 250px;
            border: 3px solid #00ff00;
            border-radius: 20px;
            box-shadow: 0 0 0 999px rgba(0,0,0,0.7);
            animation: pulse 2s infinite;
        }

        .scan-line {
            position: absolute;
            width: 250px;
            height: 2px;
            background: #00ff00;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { top: calc(50% - 125px); }
            50% { top: calc(50% + 125px); }
            100% { top: calc(50% - 125px); }
        }

        @keyframes pulse {
            0% { border-color: #00ff00; }
            50% { border-color: #ff4444; }
            100% { border-color: #00ff00; }
        }

        .controls {
            background: white;
            padding: 20px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: white;
            touch-action: manipulation;
        }

        .button.primary { background: #1e3c72; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .button.warning { background: #ffc107; color: #333; }
        .button:disabled { opacity: 0.5; }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            min-height: 60px;
        }

        .success { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #17a2b8; }

        .permission-box {
            background: #333;
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin: 20px;
        }

        .permission-box button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2em;
            margin-top: 15px;
            width: 100%;
        }

        .history {
            background: white;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .history h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .history-id { font-weight: bold; color: #1e3c72; }
        .history-time { color: #666; font-size: 0.85em; }
        .history-status { padding: 2px 10px; border-radius: 15px; font-size: 0.8em; }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }

        .debug {
            font-size: 0.8em;
            color: #666;
            text-align: center;
            margin-top: 5px;
            font-family: monospace;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± LECTOR QR AEROPUERTO</h1>
            <p>Anti-foto - Tolerancia 3 segundos</p>
        </div>

        <div class="camera-container">
            <video id="camera" playsinline autoplay muted></video>
            <div class="scan-overlay" id="scanOverlay">
                <div class="scan-frame"></div>
                <div class="scan-line"></div>
            </div>
            <div id="permissionRequest" class="permission-box">
                <p>üì∏ Necesitamos acceso a la c√°mara</p>
                <button onclick="requestCamera()">PERMITIR C√ÅMARA</button>
            </div>
        </div>

        <div class="controls">
            <div class="button-grid">
                <button class="button primary" onclick="startCamera()" id="btnStart" style="display:none;">üì∑ INICIAR</button>
                <button class="button success" onclick="captureQR()" id="btnCapture" disabled>üì∏ CAPTURAR</button>
                <button class="button danger" onclick="stopCamera()" id="btnStop" disabled>‚èπÔ∏è DETENER</button>
                <button class="button warning" onclick="toggleTorch()" id="btnTorch" disabled>üî¶ LINERNA</button>
            </div>
            
            <div id="result" class="result"></div>
            <div class="debug" id="debug"></div>
        </div>

        <div class="history" id="history">
            <h3>üìã √öLTIMOS ACCESOS</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const TOLERANCIA = 3; // segundos
        const IDS_VALIDOS = ['3384', '3395'];
        
        // Elementos
        const video = document.getElementById('camera');
        const btnCapture = document.getElementById('btnCapture');
        const btnStop = document.getElementById('btnStop');
        const btnTorch = document.getElementById('btnTorch');
        const resultDiv = document.getElementById('result');
        const permissionDiv = document.getElementById('permissionRequest');
        const scanOverlay = document.getElementById('scanOverlay');
        const debugDiv = document.getElementById('debug');
        
        let stream = null;
        let historial = [];

        // Solicitar c√°mara
        async function requestCamera() {
            try {
                permissionDiv.style.display = 'none';
                scanOverlay.style.display = 'flex';
                
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' }, // C√°mara trasera
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                await video.play();
                
                btnCapture.disabled = false;
                btnStop.disabled = false;
                
                // Verificar linterna
                const track = stream.getVideoTracks()[0];
                if (track.getCapabilities().torch) {
                    btnTorch.disabled = false;
                }
                
                mostrarResultado('üì∑ C√°mara lista - Enfoca el QR', 'info');
                
            } catch (error) {
                console.error(error);
                permissionDiv.innerHTML = `
                    <p>‚ùå Error: ${error.message}</p>
                    <button onclick="requestCamera()">REINTENTAR</button>
                `;
            }
        }

        // Capturar QR
        async function captureQR() {
            if (!stream) return;
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                
                if (code) {
                    debug('QR detectado: ' + code.data);
                    const resultado = validarQR(code.data);
                    
                    if (resultado.valido) {
                        mostrarResultado(`‚úÖ ACCESO CONCEDIDO - ${resultado.ruta}`, 'success');
                        agregarHistorial(resultado.id, true);
                        if (navigator.vibrate) navigator.vibrate(100);
                    } else {
                        mostrarResultado(`‚ùå ${resultado.motivo}`, 'error');
                        agregarHistorial('???', false);
                        if (navigator.vibrate) navigator.vibrate(200);
                    }
                } else {
                    mostrarResultado('‚ùå No se detect√≥ QR', 'error');
                }
                
            } catch (error) {
                debug('Error: ' + error.message);
            }
        }

        // Validar QR (formato: ID|HH|MM|SS)
        function validarQR(texto) {
            try {
                const partes = texto.split('|');
                
                if (partes.length !== 4) {
                    return { valido: false, motivo: 'Formato incorrecto' };
                }
                
                const [id, hora, minuto, segundo] = partes;
                
                // Validar ID
                if (!IDS_VALIDOS.includes(id)) {
                    return { valido: false, motivo: 'ID no v√°lido' };
                }
                
                // Obtener hora actual
                const ahora = new Date();
                const horaActual = ahora.getHours().toString().padStart(2, '0');
                const minActual = ahora.getMinutes().toString().padStart(2, '0');
                const segActual = ahora.getSeconds();
                
                debug(`QR: ${hora}:${minuto}:${segundo} | Actual: ${horaActual}:${minActual}:${segActual}`);
                
                // Validar hora y minuto
                if (hora !== horaActual || minuto !== minActual) {
                    return { valido: false, motivo: 'Hora incorrecta' };
                }
                
                // Validar segundos
                const diff = Math.abs(segActual - parseInt(segundo));
                if (diff > TOLERANCIA) {
                    return { valido: false, motivo: `QR expirado (${diff}s)` };
                }
                
                // ¬°V√°lido!
                return { 
                    valido: true, 
                    id: id,
                    ruta: id === '3384' ? 'T√öNEL' : 'VARIANTE'
                };
                
            } catch (e) {
                return { valido: false, motivo: 'Error de formato' };
            }
        }

        // Detener c√°mara
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                video.srcObject = null;
                stream = null;
            }
            
            btnCapture.disabled = true;
            btnStop.disabled = true;
            btnTorch.disabled = true;
            permissionDiv.style.display = 'block';
            scanOverlay.style.display = 'none';
        }

        // Linterna
        async function toggleTorch() {
            if (!stream) return;
            
            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            
            if (capabilities.torch) {
                const enabled = track.getSettings().torch;
                await track.applyConstraints({
                    advanced: [{ torch: !enabled }]
                });
            }
        }

        // Mostrar resultado
        function mostrarResultado(mensaje, tipo) {
            resultDiv.innerHTML = mensaje;
            resultDiv.className = `result ${tipo}`;
        }

        // Debug
        function debug(mensaje) {
            debugDiv.innerHTML = mensaje;
            console.log(mensaje);
        }

        // Historial
        function agregarHistorial(id, exitoso) {
            const ahora = new Date();
            historial.unshift({
                id: id,
                hora: ahora.toLocaleTimeString(),
                exitoso: exitoso
            });
            
            if (historial.length > 5) historial.pop();
            actualizarHistorial();
        }

        function actualizarHistorial() {
            let html = '';
            historial.forEach(item => {
                html += `
                    <div class="history-item">
                        <div>
                            <span class="history-id">${item.id}</span>
                            <span class="history-time">${item.hora}</span>
                        </div>
                        <span class="history-status ${item.exitoso ? 'status-success' : 'status-error'}">
                            ${item.exitoso ? '‚úÖ' : '‚ùå'}
                        </span>
                    </div>
                `;
            });
            document.getElementById('historyList').innerHTML = html;
        }

        // Iniciar
        startCamera(); // Muestra el bot√≥n de permiso
    </script>
</body>
</html>

