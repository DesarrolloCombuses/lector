<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>LECTOR QR - Aeropuerto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: #1a1a1a;
            border-radius: 20px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .camera-container {
            background: #000;
            position: relative;
            min-height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #camera {
            width: 100%;
            height: auto;
            min-height: 400px;
            object-fit: cover;
        }

        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .scan-frame {
            width: 250px;
            height: 250px;
            border: 3px solid #00ff00;
            border-radius: 20px;
            box-shadow: 0 0 0 999px rgba(0,0,0,0.7);
            animation: pulse 2s infinite;
        }

        .scan-line {
            position: absolute;
            width: 250px;
            height: 2px;
            background: #00ff00;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { top: calc(50% - 125px); }
            50% { top: calc(50% + 125px); }
            100% { top: calc(50% - 125px); }
        }

        @keyframes pulse {
            0% { border-color: #00ff00; }
            50% { border-color: #ff4444; }
            100% { border-color: #00ff00; }
        }

        .controls {
            background: white;
            padding: 20px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }

        .button.primary { background: #1e3c72; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .button.warning { background: #ffc107; color: #333; }
        .button:disabled { opacity: 0.5; }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            min-height: 60px;
        }

        .success { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border: 2px solid #17a2b8; }

        .permission-box {
            background: #333;
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin: 20px;
        }

        .permission-box button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2em;
            margin-top: 15px;
            width: 100%;
        }

        .history {
            background: white;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .history h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .history-id { font-weight: bold; color: #1e3c72; }
        .history-time { color: #666; font-size: 0.85em; }
        .history-status { padding: 2px 10px; border-radius: 15px; font-size: 0.8em; }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }

        .hora-actual {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-family: monospace;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± LECTOR QR AEROPUERTO</h1>
            <p>Tolerancia: 10 segundos - Anti-foto</p>
        </div>

        <div class="camera-container">
            <video id="camera" playsinline autoplay muted></video>
            <div class="scan-overlay" id="scanOverlay">
                <div class="scan-frame"></div>
                <div class="scan-line"></div>
            </div>
            <div id="permissionRequest" class="permission-box">
                <p>üì∏ Necesitamos acceso a la c√°mara</p>
                <button onclick="requestCamera()">PERMITIR C√ÅMARA</button>
            </div>
        </div>

        <div class="controls">
            <div class="hora-actual" id="horaActual">
                üïê Cargando hora...
            </div>
            
            <div class="button-grid">
                <button class="button success" onclick="captureQR()" id="btnCapture" disabled>üì∏ CAPTURAR</button>
                <button class="button warning" onclick="toggleTorch()" id="btnTorch" disabled>üî¶ LINERNA</button>
            </div>
            
            <div id="result" class="result"></div>
        </div>

        <div class="history" id="history">
            <h3>üìã √öLTIMOS ACCESOS</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n con tolerancia AMPLIA
        const TOLERANCIA_SEGUNDOS = 10; // Aumentado a 10 segundos
        const IDS_VALIDOS = ['3384', '3395'];
        
        // Elementos
        const video = document.getElementById('camera');
        const btnCapture = document.getElementById('btnCapture');
        const btnTorch = document.getElementById('btnTorch');
        const resultDiv = document.getElementById('result');
        const permissionDiv = document.getElementById('permissionRequest');
        const scanOverlay = document.getElementById('scanOverlay');
        const horaDiv = document.getElementById('horaActual');
        
        let stream = null;
        let historial = [];

        // Actualizar hora cada segundo
        setInterval(() => {
            const ahora = new Date();
            horaDiv.innerHTML = `üïê Hora actual: ${ahora.toLocaleTimeString()}`;
        }, 1000);

        // Solicitar c√°mara
        async function requestCamera() {
            try {
                permissionDiv.style.display = 'none';
                scanOverlay.style.display = 'flex';
                
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' },
                        width: { ideal: 1920 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await video.play();
                
                btnCapture.disabled = false;
                
                // Verificar linterna
                const track = stream.getVideoTracks()[0];
                if (track.getCapabilities().torch) {
                    btnTorch.disabled = false;
                }
                
                mostrarResultado('üì∑ C√°mara lista', 'info');
                
            } catch (error) {
                permissionDiv.innerHTML = `
                    <p>‚ùå Error: ${error.message}</p>
                    <button onclick="requestCamera()">REINTENTAR</button>
                `;
            }
        }

        // Capturar QR
        async function captureQR() {
            if (!stream) return;
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, canvas.width, canvas.height);
                
                if (code) {
                    console.log('QR Detectado:', code.data);
                    const resultado = validarQR(code.data);
                    
                    if (resultado.valido) {
                        mostrarResultado(`‚úÖ ACCESO CONCEDIDO - ${resultado.ruta}`, 'success');
                        agregarHistorial(resultado.id, true);
                        if (navigator.vibrate) navigator.vibrate(100);
                    } else {
                        mostrarResultado(`‚ùå ${resultado.motivo}`, 'error');
                        agregarHistorial('???', false);
                        if (navigator.vibrate) navigator.vibrate(200);
                    }
                } else {
                    mostrarResultado('‚ùå No se detect√≥ QR', 'error');
                }
                
            } catch (error) {
                mostrarResultado('Error al capturar', 'error');
            }
        }

        // Validar QR con TOLERANCIA MEJORADA
        function validarQR(texto) {
            try {
                // Limpiar espacios
                texto = texto.trim();
                
                // Formato esperado: ID|HHMMSS
                const partes = texto.split('|');
                
                if (partes.length !== 2) {
                    return { valido: false, motivo: `Formato incorrecto: ${texto}` };
                }
                
                const [id, horaCompacta] = partes;
                
                // Validar ID
                if (!IDS_VALIDOS.includes(id)) {
                    return { valido: false, motivo: `ID no v√°lido: ${id}` };
                }
                
                // Validar que horaCompacta tenga 6 d√≠gitos
                if (!/^\d{6}$/.test(horaCompacta)) {
                    return { valido: false, motivo: 'Formato de hora incorrecto' };
                }
                
                // Extraer hora, minuto, segundo del QR
                const horaQR = horaCompacta.substring(0, 2);
                const minutoQR = horaCompacta.substring(2, 4);
                const segundoQR = parseInt(horaCompacta.substring(4, 6));
                
                // Obtener hora actual
                const ahora = new Date();
                const horaActual = ahora.getHours().toString().padStart(2, '0');
                const minutoActual = ahora.getMinutes().toString().padStart(2, '0');
                const segundoActual = ahora.getSeconds();
                
                console.log(`QR: ${horaQR}:${minutoQR}:${segundoQR} | Actual: ${horaActual}:${minutoActual}:${segundoActual}`);
                
                // VALIDACI√ìN M√ÅS FLEXIBLE:
                
                // 1. La hora debe ser la misma (l√≥gico)
                if (horaQR !== horaActual) {
                    return { valido: false, motivo: `Hora incorrecta (QR:${horaQR} Actual:${horaActual})` };
                }
                
                // 2. El minuto puede tener 1 minuto de diferencia (por si el QR se gener√≥ justo en el cambio de minuto)
                const diffMinutos = Math.abs(parseInt(minutoQR) - parseInt(minutoActual));
                if (diffMinutos > 1) {
                    return { valido: false, motivo: `Minuto incorrecto (QR:${minutoQR} Actual:${minutoActual})` };
                }
                
                // 3. Los segundos pueden tener hasta 10 segundos de diferencia
                let diffSegundos;
                if (minutoQR === minutoActual) {
                    // Mismo minuto
                    diffSegundos = Math.abs(segundoActual - segundoQR);
                } else if (parseInt(minutoQR) < parseInt(minutoActual)) {
                    // QR de minuto anterior
                    diffSegundos = (60 - segundoQR) + segundoActual;
                } else {
                    // QR de minuto siguiente (poco probable)
                    diffSegundos = segundoQR + (60 - segundoActual);
                }
                
                if (diffSegundos > TOLERANCIA_SEGUNDOS) {
                    return { valido: false, motivo: `QR expirado (${diffSegundos}s > ${TOLERANCIA_SEGUNDOS}s)` };
                }
                
                // ¬°V√°lido!
                const nombreRuta = id === '3384' ? 'T√öNEL' : 'VARIANTE PALMAS';
                return { valido: true, id, ruta: nombreRuta };
                
            } catch (error) {
                console.error(error);
                return { valido: false, motivo: 'Error al procesar' };
            }
        }

        // Linterna
        async function toggleTorch() {
            if (!stream) return;
            const track = stream.getVideoTracks()[0];
            if (track.getCapabilities().torch) {
                const enabled = track.getSettings().torch;
                await track.applyConstraints({
                    advanced: [{ torch: !enabled }]
                });
            }
        }

        function mostrarResultado(mensaje, tipo) {
            resultDiv.innerHTML = mensaje;
            resultDiv.className = `result ${tipo}`;
        }

        function agregarHistorial(id, exitoso) {
            const ahora = new Date();
            historial.unshift({
                id: id,
                hora: ahora.toLocaleTimeString(),
                exitoso: exitoso
            });
            
            if (historial.length > 5) historial.pop();
            
            let html = '';
            historial.forEach(item => {
                html += `
                    <div class="history-item">
                        <div>
                            <span class="history-id">${item.id}</span>
                            <span class="history-time">${item.hora}</span>
                        </div>
                        <span class="history-status ${item.exitoso ? 'status-success' : 'status-error'}">
                            ${item.exitoso ? '‚úÖ' : '‚ùå'}
                        </span>
                    </div>
                `;
            });
            document.getElementById('historyList').innerHTML = html;
        }

        // Iniciar
        requestCamera();
    </script>
</body>
</html>

